<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Exams</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 16px;
      background: #f6f7f9;
    }
    h2 {
      text-align: center;
    }
    .exam {
      background: white;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .exam:hover {
      background: #eef2ff;
    }
    .date {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .title {
      color: #555;
    }
    .error {
      color: #c00;
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h2>üìò My Exams</h2>
<div id="examList"></div>
<p id="error" class="error"></p>

<script>
/* ==========================
   CONFIG
========================== */
const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY";
const BUCKET = "exam-data";

/* ==========================
   TOKEN FROM URL
========================== */
const params = new URLSearchParams(window.location.search);
const token = params.get("token");

if (!token) {
  showError("Invalid access link.");
  throw new Error("No token provided");
}

/* ==========================
   SUPABASE CLIENT
========================== */
const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ==========================
   INIT
========================== */
loadAgenda();

/* ==========================
   LOAD AGENDA
========================== */
async function loadAgenda() {
  const examsPath = `students/${token}/exams`;

  // 1Ô∏è‚É£ List exam directories
  const { data: folders, error } = await supabase
    .storage
    .from(BUCKET)
    .list(examsPath, {
      sortBy: { column: "name", order: "desc" }
    });

  if (error) {
    showError("Unable to load exams.");
    return;
  }

  if (!folders || folders.length === 0) {
    showError("No exams available.");
    return;
  }

  // 2Ô∏è‚É£ Load exam.json from each exam folder
  for (const folder of folders) {
    const examJsonPath =
      `${examsPath}/${folder.name}/exam.json`;

    const { data: signed } = await supabase
      .storage
      .from(BUCKET)
      .createSignedUrl(examJsonPath, 60);

    if (!signed) continue;

    const res = await fetch(signed.signedUrl);
    if (!res.ok) continue;

    const exam = await res.json();
    renderExam(folder.name, exam);
  }
}

/* ==========================
   RENDER
========================== */
function renderExam(examDir, exam) {
  const div = document.createElement("div");
  div.className = "exam";

  div.innerHTML = `
    <div class="date">üìÖ ${exam.date}</div>
    <div class="title">${exam.title}</div>
  `;

  div.onclick = () => {
    window.location.href =
      `view_exam.html?token=${token}&exam=${examDir}`;
  };

  document.getElementById("examList").appendChild(div);
}

/* ==========================
   ERROR
========================== */
function showError(msg) {
  document.getElementById("error").textContent = msg;
}
</script>

</body>
</html>
