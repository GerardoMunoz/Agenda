<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Correct Blocks</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: auto;
    }

    #canvasWrapper {
      position: relative;
      display: inline-block;
      border: 1px solid #ccc;
    }

    #examImage {
      max-width: 100%;
      display: block;
    }

    .block {
      position: absolute;
      border: 2px solid green;
      box-sizing: border-box;
      cursor: pointer;
    }

    .block.selected {
      border-color: red;
    }

    .block-controls {
      position: absolute;
      top: 2px;
      left: 2px;
      background: rgba(255,255,255,0.9);
      padding: 2px 4px;
      font-size: 11px;
      display: none;
      z-index: 10;
    }

    .block:hover .block-controls,
    .block.selected .block-controls {
      display: block;
    }

    .block-content {
      padding: 18px 4px 4px 4px;
      font-size: 13px;
      overflow: hidden;
    }

    #panel {
      margin-top: 15px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }

    textarea {
      width: 100%;
      height: 80px;
    }

    button {
      margin-top: 8px;
      padding: 6px 10px;
    }
  </style>
</head>
<body>

<h2>ðŸ§  Correct Transcribed Blocks</h2>

<div id="canvasWrapper">
  <img id="examImage" />
</div>

<div id="panel" hidden>
  <h3>Add correction</h3>
  <textarea id="correction"></textarea><br>
  <button id="saveCorrection">ðŸ’¾ Save correction</button>
</div>

<script>
/* ================= CONFIG ================= */

const SUPABASE_URL = "https://ztucdmcleqajxvyabiyv.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_tQtSGptUIUbRedUARlPgBQ__LX8N41m";
const BUCKET = "exam-data";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ================= PARAMS ================= */

const params = new URLSearchParams(location.search);
const token = params.get("token");
const examId = params.get("exam");
const pageFile = params.get("page");

if (!token || !examId || !pageFile) {
  document.body.innerHTML = "<h3>Invalid link</h3>";
  throw new Error("Missing params");
}

/* ================= IMAGE ================= */

const img = document.getElementById("examImage");
const wrapper = document.getElementById("canvasWrapper");

(async () => {
  const { data } = await supabaseClient.storage
    .from(BUCKET)
    .createSignedUrl(
      `students/${token}/exams/${examId}/${pageFile}`,
      1800
    );

  img.src = data.signedUrl;
})();

/* ================= LOAD EVENTS ================= */

let selectedBlockId = null;

img.onload = () => {
  requestAnimationFrame(loadBlocksFromAgenda);
};

async function loadBlocksFromAgenda() {
  const { data: files } =
    await supabaseClient.storage
      .from(BUCKET)
      .list(`students/${token}/agenda`);

  const blocks = {};

  for (const f of files) {
    const { data } =
      await supabaseClient.storage
        .from(BUCKET)
        .download(`students/${token}/agenda/${f.name}`);

    const evt = JSON.parse(await data.text());

    if (
      (evt.type === "block_added" || evt.type === "block_corrected") &&
      evt.examId === examId &&
      evt.page === pageFile
    ) {
      const blockId = evt.blockId || evt.sourceBlock || f.name;

      blocks[blockId] ??= {
        rect: evt,
        versions: []
      };

      blocks[blockId].versions.push(evt);
    }
  }

  Object.entries(blocks).forEach(([blockId, data]) => {
    renderBlock(blockId, data.versions, data.rect);
  });
}

/* ================= RENDER BLOCK ================= */

function renderBlock(blockId, versions, rect) {
  const block = document.createElement("div");
  block.className = "block";

  block.style.left = rect.x * img.clientWidth + "px";
  block.style.top = rect.y * img.clientHeight + "px";
  block.style.width = rect.width * img.clientWidth + "px";
  block.style.height = rect.height * img.clientHeight + "px";

  const controls = document.createElement("div");
  controls.className = "block-controls";

  const content = document.createElement("div");
  content.className = "block-content";

  versions.forEach((v, i) => {
    const label = document.createElement("label");
    const radio = document.createElement("input");

    radio.type = "radio";
    radio.name = blockId;
    radio.checked = i === 0;

    radio.onchange = () => {
      content.textContent = v.latex;
      MathJax.typesetPromise([content]);
    };

    label.appendChild(radio);
    label.append(" " + (i === 0 ? "T" : `C${i}`));
    controls.appendChild(label);

    if (i === 0) {
      content.textContent = v.latex;
    }
  });

  block.onclick = () => {
    document
      .querySelectorAll(".block")
      .forEach(b => b.classList.remove("selected"));

    block.classList.add("selected");
    selectedBlockId = blockId;
    document.getElementById("panel").hidden = false;
  };

  block.appendChild(controls);
  block.appendChild(content);
  wrapper.appendChild(block);

  MathJax.typesetPromise([block]);
}

/* ================= SAVE CORRECTION ================= */

document.getElementById("saveCorrection").onclick = async () => {
  if (!selectedBlockId) return;

  const text = document
    .getElementById("correction")
    .value.trim();

  if (!text) return;

  const evt = {
    type: "block_corrected",
    examId,
    page: pageFile,
    blockId: selectedBlockId,
    latex: text,
    createdAt: new Date().toISOString()
  };

  const name =
    `students/${token}/agenda/${new Date().toISOString()}.block_corrected.json`;

  await supabaseClient.storage
    .from(BUCKET)
    .upload(name, new Blob([JSON.stringify(evt, null, 2)]));

  alert("Correction saved âœ…");
  location.reload();
};
</script>

</body>
</html>
