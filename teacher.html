<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher ‚Äì Event-based Exam Upload</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 720px;
      margin: auto;
    }
    img {
      max-width: 100%;
      margin-top: 8px;
      border: 1px solid #ccc;
    }
    button {
      margin: 6px 0;
    }
    hr {
      margin: 20px 0;
    }
  </style>
</head>
<body>

<h2>üìò Teacher ‚Äì Exam Upload (Event-based)</h2>

<!-- STUDENT -->
<h3>Student</h3>

<select id="studentSelect"></select>
<button onclick="showNewStudent()">‚ûï New student</button>

<div id="newStudentBox" style="display:none;">
  <input id="studentCode" placeholder="ALG001" />
  <button onclick="createStudent()">Create</button>
</div>

<p id="studentInfo"></p>

<hr />

<!-- EXAM -->
<h3>Exam</h3>
<input id="examName" placeholder="Exam name (ex2)" />

<hr />

<!-- IMAGES -->
<h3>Upload pages</h3>

<input
  type="file"
  accept="image/*"
  capture="environment"
  multiple
  onchange="handleImages(event)"
/>

<div id="preview"></div>

<button onclick="uploadExam()">‚¨Ü Upload</button>

<hr />

<h3>Student URL</h3>
<input id="studentUrl" style="width:100%" readonly />

<hr />

<h3>Student registry</h3>
<button onclick="exportStudents()">‚¨á Export students</button>
<input type="file" accept=".json" onchange="importStudents(event)" />

<script>
/* ================= CONFIG ================= */

const SUPABASE_URL = "https://ztucdmcleqajxvyabiyv.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_tQtSGptUIUbRedUARlPgBQ__LX8N41m";
const BUCKET = "exam-data";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ================= STATE ================= */

let students = JSON.parse(localStorage.getItem("students") || "[]");
let currentStudent = null;
let images = [];

/* ================= INIT ================= */

refreshStudents();

/* ================= STUDENTS ================= */

function exportStudents() {
  const blob = new Blob(
    [JSON.stringify(students, null, 2)],
    { type: "application/json" }
  );

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "students.json";
  a.click();
}

function importStudents(e) {
  const file = e.target.files[0];
  if (!file) return;

  file.text().then(text => {
    try {
      const imported = JSON.parse(text);
      if (!Array.isArray(imported)) throw "Invalid format";

      students = imported;
      localStorage.setItem("students", JSON.stringify(students));
      refreshStudents();
      alert("Students imported ‚úî");
    } catch {
      alert("Invalid students.json");
    }
  });
}

function refreshStudents() {
  const sel = document.getElementById("studentSelect");
  sel.innerHTML = "";

  students.forEach((s, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = s.student_code;
    sel.appendChild(opt);
  });

  sel.onchange = () => {
    currentStudent = students[sel.value];
    updateStudentInfo();
  };

  if (students.length > 0) {
    currentStudent = students[0];
    updateStudentInfo();
  }
}

function showNewStudent() {
  document.getElementById("newStudentBox").style.display = "block";
}

function createStudent() {
  const code = document.getElementById("studentCode").value.trim();
  if (!code) return alert("Student code required");

  const token = crypto.randomUUID().replaceAll("-", "");
  const folder = `${code}_${token}`;

  students.push({ student_code: code, folder });
  localStorage.setItem("students", JSON.stringify(students));

  document.getElementById("studentCode").value = "";
  document.getElementById("newStudentBox").style.display = "none";

  refreshStudents();
}

function updateStudentInfo() {
  document.getElementById("studentInfo").textContent =
    `Folder: ${currentStudent.folder}`;
}

/* ================= IMAGES ================= */

function handleImages(e) {
  images = [...e.target.files];
  const preview = document.getElementById("preview");
  preview.innerHTML = "";

  images.forEach(file => {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    preview.appendChild(img);
  });
}

/* ================= AGENDA EVENTS ================= */

function isoNowSafe() {
  return new Date().toISOString().replace(/[:.]/g, "-");
}

async function writeAgendaEvent(studentFolder, event) {
  const path =
    `students/${studentFolder}/agenda/` +
    `${isoNowSafe()}.${event.type}.json`;

  await supabaseClient.storage
    .from(BUCKET)
    .upload(
      path,
      JSON.stringify(event, null, 2),
      { contentType: "application/json" }
    );
}

/* ================= UPLOAD ================= */

async function uploadExam() {
  if (!currentStudent) return alert("Select student");
  if (!images.length) return alert("No images");
  const examName = document.getElementById("examName").value.trim();
  if (!examName) return alert("Exam name required");

  const date = new Date().toISOString().slice(0, 10);
  const examId = `${date}_${examName}`;
  const basePath =
    `students/${currentStudent.folder}/exams/${examId}`;

  // 1Ô∏è‚É£ exam_created
  await writeAgendaEvent(currentStudent.folder, {
    type: "exam_created",
    examId,
    examName,
    date
  });

  // 2Ô∏è‚É£ pages
  for (const file of images) {
    const ext = file.name.split(".").pop() || "jpg";
    const ts = isoNowSafe();
    const pageName = `page_${ts}.${ext}`;
    const pagePath = `${basePath}/${pageName}`;

    await supabaseClient.storage
      .from(BUCKET)
      .upload(pagePath, file, { upsert: false });

    await writeAgendaEvent(currentStudent.folder, {
      type: "page_added",
      examId,
      file: pageName
    });
  }

  document.getElementById("studentUrl").value =
    `https://gerardomunoz.github.io/Agenda/student.html` +
    `?token=${currentStudent.folder}`;

  alert("Exam uploaded ‚úî");
}
</script>

</body>
</html>
